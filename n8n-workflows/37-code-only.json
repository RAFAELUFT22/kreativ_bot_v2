{
    "name": "Kreativ: Code Only Router",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "ai-tutor-v2",
                "responseMode": "onReceived",
                "options": {}
            },
            "id": "webhook-code",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                200,
                300
            ],
            "webhookId": "kreativ-code-only"
        },
        {
            "parameters": {
                "jsCode": "const input = $json.body || $json;\nconst phone = input.phone || '556399374165';\nconst message = input.body || 'Oi';\n\n// Helpers\nasync function query(sql, params) {\n  const res = await fetch('http://kreativ_builderbot:3008/api/query', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ query: sql, values: params })\n  });\n  if (!res.ok) throw new Error('Query failed: ' + res.statusText);\n  const data = await res.json();\n  return data.rows;\n}\n\nasync function callLLM(system, user) {\n  const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Authorization': 'Bearer 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',\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      model: 'deepseek/deepseek-chat',\n      messages: [\n        { role: 'system', content: system },\n        { role: 'user', content: user }\n      ]\n    })\n  });\n  const data = await res.json();\n  return data.choices?.[0]?.message?.content || 'Erro na IA';\n}\n\n// Logic\ntry {\n  // 1. Get Student\n  console.log('Fetching student...');\n  const students = await query('SELECT name, course_id, current_module FROM students WHERE phone = $1', [phone]);\n  const student = students[0] || { name: 'Visitante', course_id: 19, current_module: 1 };\n\n  // 2. Get Module\n  console.log('Fetching module...');\n  const modules = await query('SELECT title, content_text as syllabus FROM modules m JOIN courses c ON m.course_id = c.slug WHERE c.id = $1 AND m.module_number = $2', [student.course_id, student.current_module]);\n  const mod = modules[0] || { title: 'Intro', syllabus: 'Conteúdo padrão.' };\n\n  // 3. Call LLM\n  console.log('Calling LLM...');\n  const systemPrompt = `ALUNO: ${student.name}\\nEMENTA: ${mod.syllabus}\\n\\nDê a aula amigável.`;\n  const reply = await callLLM(systemPrompt, message);\n\n  // 4. Send WhatsApp\n  console.log('Sending WhatsApp...');\n  await fetch('http://kreativ_builderbot:3008/api/send', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ phone, message: reply })\n  });\n\n  return [{ json: { status: 'success', phone, reply } }];\n} catch (error) {\n  return [{ json: { error: error.message } }];\n}"
            },
            "id": "code-logic",
            "name": "Code Logic",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                400,
                300
            ]
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Code Logic",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1",
        "saveDataSuccessExecution": false,
        "saveExecutionProgress": false
    }
}