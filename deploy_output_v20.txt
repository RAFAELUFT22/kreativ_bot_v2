Found existing workflow: TVYcwBvRkHKWjhrC
Update Status: 200 {"updatedAt":"2026-02-19T14:15:25.511Z","createdAt":"2026-02-19T11:47:25.001Z","id":"TVYcwBvRkHKWjhrC","name":"Kreativ: AI Cognitive Router","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"ai-router","responseMode":"onReceived","options":{}},"id":"webhook-start","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[260,340],"webhookId":"kreativ-ai-router"},{"parameters":{"operation":"executeQuery","query":"={{ \"SELECT name, course_id, current_module FROM students WHERE phone = '\" + $node[\"Webhook\"].json.body.phone + \"' LIMIT 1\" }}"},"id":"get-student","name":"Get Student","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[480,340],"credentials":{"postgres":{"id":"lJaeEy4CpHbhgMAp","name":"Kreativ PostgreSQL"}}},{"parameters":{"operation":"executeQuery","query":"={{ \"SELECT title, content_text FROM modules WHERE course_id = '\" + String($json.course_id || '19') + \"' AND module_number = \" + ($json.current_module || 1) + \" LIMIT 1\" }}"},"id":"get-module","name":"Get Module","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[700,340],"credentials":{"postgres":{"id":"lJaeEy4CpHbhgMAp","name":"Kreativ PostgreSQL"}}},{"parameters":{"jsCode":"return [{\n  json: {\n    student_name: $node[\"Get Student\"].json.name || 'Estudante',\n    course_id: $node[\"Get Student\"].json.course_id || '19',\n    current_module: $node[\"Get Student\"].json.current_module || 1,\n    module_title: $node[\"Get Module\"].json.title || 'Iniciação',\n    module_content: $node[\"Get Module\"].json.content_text || 'Olá! Prontos para começar?',\n    user_message: $node[\"Webhook\"].json.body.body,\n    phone: $node[\"Webhook\"].json.body.phone\n  }\n}];"},"id":"aggregator","name":"Context Aggregator","type":"n8n-nodes-base.code","typeVersion":2,"position":[920,340]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer 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"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  model: 'deepseek/deepseek-chat',\n  messages: [\n    {\n      role: 'system',\n      content: `Você é o Tutor IA da Kreativ Educação. Sua missão é guiar o aluno por pílulas de conhecimento e avaliações.\\n\\nALUNO: ${$json.student_name}\\nCURSO: ${$json.course_id}\\nMÓDULO: ${$json.current_module} - ${$json.module_title}\\n\\nCONTEÚDO:\\n${$json.module_content}\\n\\nDIRETRIZES:\\n1. Seja amigável e use o nome do aluno.\\n2. Sempre faça uma pergunta de verificação após explicar algo.\\n3. Use action=\"handover\" se o aluno quiser um humano.\\n4. Responda APENAS em JSON: { \"action\": \"reply\"|\"handover\", \"text\": \"...\" }.` \n    },\n    {\n      role: 'user',\n      content: $json.user_message \n    }\n  ]\n}) }}","options":{"timeout":35000}},"id":"openrouter-api","name":"OpenRouter","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1140,340]},{"parameters":{"jsCode":"const res = $json.choices[0].message.content;\ntry {\n  const clean = res.replace(/```json/g, '').replace(/```/g, '').trim();\n  return [{ json: JSON.parse(clean) }];\n} catch (e) {\n  return [{ json: { action: 'reply', text: res } }];\n}"},"id":"parse-llm","name":"Parse","type":"n8n-nodes-base.code","typeVersion":2,"position":[1360,340]},{"parameters":{"operation":"executeQuery","query":"={{ \"INSERT INTO debug_log (message) VALUES ('Final v20: ' + $json.action + ' | ' + $json.text.substring(0, 50)) RETURNING id\" }}"},"id":"log-final","name":"Log Final","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1580,340],"credentials":{"postgres":{"id":"lJaeEy4CpHbhgMAp","name":"Kreativ PostgreSQL"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $node[\"Parse\"].json.action }}","value2":"handover"}]}},"id":"if-handover","name":"If Handover","type":"n8n-nodes-base.if","typeVersion":1,"position":[1800,340]},{"parameters":{"method":"POST","url":"http://localhost:5678/webhook/request-human-support","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $node[\"Webhook\"].json.body.phone, reason: 'Escalonamento' }) }}"},"id":"trigger-support","name":"Trigger Support","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2020,240]},{"parameters":{"method":"POST","url":"http://kreativ_builderbot:3008/api/send","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $node[\"Webhook\"].json.body.phone, message: $node[\"Parse\"].json.text }) }}"},"id":"send-wa","name":"Send WhatsApp","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2020,440]}],"connections":{"Webhook":{"main":[[{"node":"Get Student","type":"main","index":0}]]},"Get Student":{"main":[[{"node":"Get Module","type":"main","index":0}]]},"Get Module":{"main":[[{"node":"Context Aggregator","type":"main","index":0}]]},"Context Aggregator":{"main":[[{"node":"OpenRouter","type":"main","index":0}]]},"OpenRouter":{"main":[[{"node":"Parse","type":"main","index":0}]]},"Parse":{"main":[[{"node":"Log Final","type":"main","index":0}]]},"Log Final":{"main":[[{"node":"If Handover","type":"main","index":0}]]},"If Handover":{"main":[[{"node":"Trigger Support","type":"main","index":0}],[{"node":"Send WhatsApp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"96b30971-d601-4c77-aaf9-447ec081eaa4","activeVersionId":"96b30971-d601-4c77-aaf9-447ec081eaa4","versionCounter":47,"triggerCount":1,"tags":[],"activeVersion":{"updatedAt":"2026-02-19T14:15:25.513Z","createdAt":"2026-02-19T14:15:25.513Z","versionId":"96b30971-d601-4c77-aaf9-447ec081eaa4","workflowId":"TVYcwBvRkHKWjhrC","nodes":[{"parameters":{"httpMethod":"POST","path":"ai-router","responseMode":"onReceived","options":{}},"id":"webhook-start","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[260,340],"webhookId":"kreativ-ai-router"},{"parameters":{"operation":"executeQuery","query":"={{ \"SELECT name, course_id, current_module FROM students WHERE phone = '\" + $node[\"Webhook\"].json.body.phone + \"' LIMIT 1\" }}"},"id":"get-student","name":"Get Student","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[480,340],"credentials":{"postgres":{"id":"lJaeEy4CpHbhgMAp","name":"Kreativ PostgreSQL"}}},{"parameters":{"operation":"executeQuery","query":"={{ \"SELECT title, content_text FROM modules WHERE course_id = '\" + String($json.course_id || '19') + \"' AND module_number = \" + ($json.current_module || 1) + \" LIMIT 1\" }}"},"id":"get-module","name":"Get Module","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[700,340],"credentials":{"postgres":{"id":"lJaeEy4CpHbhgMAp","name":"Kreativ PostgreSQL"}}},{"parameters":{"jsCode":"return [{\n  json: {\n    student_name: $node[\"Get Student\"].json.name || 'Estudante',\n    course_id: $node[\"Get Student\"].json.course_id || '19',\n    current_module: $node[\"Get Student\"].json.current_module || 1,\n    module_title: $node[\"Get Module\"].json.title || 'Iniciação',\n    module_content: $node[\"Get Module\"].json.content_text || 'Olá! Prontos para começar?',\n    user_message: $node[\"Webhook\"].json.body.body,\n    phone: $node[\"Webhook\"].json.body.phone\n  }\n}];"},"id":"aggregator","name":"Context Aggregator","type":"n8n-nodes-base.code","typeVersion":2,"position":[920,340]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer 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"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  model: 'deepseek/deepseek-chat',\n  messages: [\n    {\n      role: 'system',\n      content: `Você é o Tutor IA da Kreativ Educação. Sua missão é guiar o aluno por pílulas de conhecimento e avaliações.\\n\\nALUNO: ${$json.student_name}\\nCURSO: ${$json.course_id}\\nMÓDULO: ${$json.current_module} - ${$json.module_title}\\n\\nCONTEÚDO:\\n${$json.module_content}\\n\\nDIRETRIZES:\\n1. Seja amigável e use o nome do aluno.\\n2. Sempre faça uma pergunta de verificação após explicar algo.\\n3. Use action=\"handover\" se o aluno quiser um humano.\\n4. Responda APENAS em JSON: { \"action\": \"reply\"|\"handover\", \"text\": \"...\" }.` \n    },\n    {\n      role: 'user',\n      content: $json.user_message \n    }\n  ]\n}) }}","options":{"timeout":35000}},"id":"openrouter-api","name":"OpenRouter","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1140,340]},{"parameters":{"jsCode":"const res = $json.choices[0].message.content;\ntry {\n  const clean = res.replace(/```json/g, '').replace(/```/g, '').trim();\n  return [{ json: JSON.parse(clean) }];\n} catch (e) {\n  return [{ json: { action: 'reply', text: res } }];\n}"},"id":"parse-llm","name":"Parse","type":"n8n-nodes-base.code","typeVersion":2,"position":[1360,340]},{"parameters":{"operation":"executeQuery","query":"={{ \"INSERT INTO debug_log (message) VALUES ('Final v20: ' + $json.action + ' | ' + $json.text.substring(0, 50)) RETURNING id\" }}"},"id":"log-final","name":"Log Final","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1580,340],"credentials":{"postgres":{"id":"lJaeEy4CpHbhgMAp","name":"Kreativ PostgreSQL"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $node[\"Parse\"].json.action }}","value2":"handover"}]}},"id":"if-handover","name":"If Handover","type":"n8n-nodes-base.if","typeVersion":1,"position":[1800,340]},{"parameters":{"method":"POST","url":"http://localhost:5678/webhook/request-human-support","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $node[\"Webhook\"].json.body.phone, reason: 'Escalonamento' }) }}"},"id":"trigger-support","name":"Trigger Support","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2020,240]},{"parameters":{"method":"POST","url":"http://kreativ_builderbot:3008/api/send","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ phone: $node[\"Webhook\"].json.body.phone, message: $node[\"Parse\"].json.text }) }}"},"id":"send-wa","name":"Send WhatsApp","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2020,440]}],"connections":{"Webhook":{"main":[[{"node":"Get Student","type":"main","index":0}]]},"Get Student":{"main":[[{"node":"Get Module","type":"main","index":0}]]},"Get Module":{"main":[[{"node":"Context Aggregator","type":"main","index":0}]]},"Context Aggregator":{"main":[[{"node":"OpenRouter","type":"main","index":0}]]},"OpenRouter":{"main":[[{"node":"Parse","type":"main","index":0}]]},"Parse":{"main":[[{"node":"Log Final","type":"main","index":0}]]},"Log Final":{"main":[[{"node":"If Handover","type":"main","index":0}]]},"If Handover":{"main":[[{"node":"Trigger Support","type":"main","index":0}],[{"node":"Send WhatsApp","type":"main","index":0}]]}},"authors":"Rafael da Silva","name":null,"description":null,"autosaved":false}}
